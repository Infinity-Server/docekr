#!/bin/bash

pid='-1'

do_umount() {
  kill -9 $pid
  echo 'Exiting ...'
  umount /rootfs/downloads
  umount /rootfs/proc
  umount /rootfs/tmp
  umount /rootfs/sys
  umount /rootfs/dev
}

if [ ! -f /rootfs/etc/synoinfo.conf ];
then
  rand=$(cat /proc/sys/kernel/random/uuid | awk -F '-' '{print $1}')
  echo "unique=\"synology_${rand}_720+\"" > /rootfs/etc/synoinfo.conf
fi
cat /etc/resolv.conf > /rootfs/etc/resolv.conf

mount -o bind /dev /rootfs/dev
mount -o bind /sys /rootfs/sys
mount -t proc proc /rootfs/proc
mount -t tmpfs tmpfs /rootfs/tmp
mount -o bind /downloads /rootfs/downloads

chroot /rootfs /var/packages/pan-xunlei-com/xunlei_cgi &
pid=$(ps -e -o pid,cmd | grep xunlei_cgi | grep -v grep | awk '{print $1}' | xargs)

trap 'do_umount' SIGINT
trap 'do_umount' SIGHUP
trap 'do_umount' SIGTERM

wait $pid
do_umount
