<!DOCTYPE html>
<html>
  <head>
    <title>WebAuthn</title>
    <meta charset="UTF-8">
    <script>
      async function register() {
        try {
          // check browser support
          if (!window.fetch || !navigator.credentials || !navigator.credentials.create) {
            throw new Error('Browser not supported.');
          }

          // get create args
          let rep = await window.fetch('webauthn.php?fn=getCreateArgs' + getGetParams(), {method:'GET', cache:'no-cache'});
          const createArgs = await rep.json();

          // error handling
          if (createArgs.success === false) {
            throw new Error(createArgs.msg || 'unknown error occured');
          }

          recursiveBase64StrToArrayBuffer(createArgs);

          // create credentials
          const cred = await navigator.credentials.create(createArgs);

          // create object
          const authenticatorAttestationResponse = {
            transports: cred.response.getTransports  ? cred.response.getTransports() : null,
            clientDataJSON: cred.response.clientDataJSON  ? arrayBufferToBase64(cred.response.clientDataJSON) : null,
            attestationObject: cred.response.attestationObject ? arrayBufferToBase64(cred.response.attestationObject) : null
          };

          // check auth on server side
          rep = await window.fetch('webauthn.php?fn=processCreate' + getGetParams(), {
            method  : 'POST',
            body    : JSON.stringify(authenticatorAttestationResponse),
            cache   : 'no-cache'
          });
          const authenticatorAttestationServerResponse = await rep.json();

          // prompt server response
          if (authenticatorAttestationServerResponse.success) {
            window.alert(authenticatorAttestationServerResponse.msg || 'registration success');

          } else {
            throw new Error(authenticatorAttestationServerResponse.msg);
          }

        } catch (err) {
          window.alert(err.message || 'unknown error occured');
        }
      }

      async function authenticate() {
        try {

          if (!window.fetch || !navigator.credentials || !navigator.credentials.create) {
            throw new Error('Browser not supported.');
          }

          // get check args
          let rep = await window.fetch('webauthn.php?fn=getGetArgs' + getGetParams(), {method:'GET',cache:'no-cache'});
          const getArgs = await rep.json();

          // error handling
          if (getArgs.success === false) {
            throw new Error(getArgs.msg);
          }

          recursiveBase64StrToArrayBuffer(getArgs);

          // check credentials with hardware
          const cred = await navigator.credentials.get(getArgs);

          // create object for transmission to server
          const authenticatorAttestationResponse = {
            id: cred.rawId ? arrayBufferToBase64(cred.rawId) : null,
            clientDataJSON: cred.response.clientDataJSON  ? arrayBufferToBase64(cred.response.clientDataJSON) : null,
            authenticatorData: cred.response.authenticatorData ? arrayBufferToBase64(cred.response.authenticatorData) : null,
            signature: cred.response.signature ? arrayBufferToBase64(cred.response.signature) : null,
            userHandle: cred.response.userHandle ? arrayBufferToBase64(cred.response.userHandle) : null
          };

          // send to server
          rep = await window.fetch('webauthn.php?fn=processGet' + getGetParams(), {
            method:'POST',
            body: JSON.stringify(authenticatorAttestationResponse),
            cache:'no-cache'
          });
          const authenticatorAttestationServerResponse = await rep.json();

          // check server response
          if (authenticatorAttestationServerResponse.success) {
            window.alert(authenticatorAttestationServerResponse.msg || 'login success');
          } else {
            throw new Error(authenticatorAttestationServerResponse.msg);
          }

        } catch (err) {
          window.alert(err.message || 'unknown error occured');
        }
      }

      function clearRegistration() {
        window.fetch('webauthn.php?fn=clearRegistrations' + getGetParams(), {method:'GET',cache:'no-cache'}).then(function(response) {
          return response.json();

        }).then(function(json) {
          if (json.success) {
            window.alert(json.msg);
          } else {
            throw new Error(json.msg);
          }
        }).catch(function(err) {
          window.alert(err.message || 'unknown error occured');
        });
      }

      function recursiveBase64StrToArrayBuffer(obj) {
        let prefix = '=?BINARY?B?';
        let suffix = '?=';
        if (typeof obj === 'object') {
          for (let key in obj) {
            if (typeof obj[key] === 'string') {
              let str = obj[key];
              if (str.substring(0, prefix.length) === prefix && str.substring(str.length - suffix.length) === suffix) {
                str = str.substring(prefix.length, str.length - suffix.length);

                let binary_string = window.atob(str);
                let len = binary_string.length;
                let bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++)        {
                  bytes[i] = binary_string.charCodeAt(i);
                }
                obj[key] = bytes.buffer;
              }
            } else {
              recursiveBase64StrToArrayBuffer(obj[key]);
            }
          }
        }
      }

      function arrayBufferToBase64(buffer) {
        let binary = '';
        let bytes = new Uint8Array(buffer);
        let len = bytes.byteLength;
        for (let i = 0; i < len; i++) {
          binary += String.fromCharCode( bytes[ i ] );
        }
        return window.btoa(binary);
      }

      function getGetParams() {
        let url = '';
        url += '&userId=737072696e676861636b';
        url += '&userName=springhack';
        url += '&userDisplayName=SpringHack';
        return url;
      }
    </script>
  </head>
  <body>
    <button type="button" onclick="register()">Register</button>
    <button type="button" onclick="authenticate()">Authenticate</button>
    <button type="button" onclick="clearRegistration()">Clear All Registrations</button>
  </body>
</html>
